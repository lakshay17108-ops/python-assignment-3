# cli.py
# Simple menu-driven CLI for the library inventory.
import logging
from pathlib import Path

from library_manager.inventory import LibraryInventory
from library_manager.book import Book

# Define paths inside a dedicated "data" folder
DATA_DIR = Path("data")
LOG_FILE = DATA_DIR / "library.log"
CATALOG = DATA_DIR / "catalog.json"


def setup_logging():
    # Ensure data directory exists
    DATA_DIR.mkdir(parents=True, exist_ok=True)

    logging.basicConfig(
        level=logging.INFO,
        format="%(asctime)s %(levelname)s: %(message)s",
        handlers=[
            logging.FileHandler(LOG_FILE, encoding="utf-8"),
            logging.StreamHandler(),
        ]
    )


def prompt_non_empty(prompt_text: str) -> str:
    while True:
        val = input(prompt_text).strip()
        if val:
            return val
        print("Input cannot be empty. Please try again.")


def main():
    setup_logging()
    logger = logging.getLogger(__name__)

    inventory = LibraryInventory(CATALOG)
    try:
        inventory.load()
    except Exception as e:
        logger.error(f"Failed to load inventory: {e}")

    try:
        while True:
            print("\n=== Library Inventory Manager ===")
            print("1. Add Book")
            print("2. Issue Book")
            print("3. Return Book")
            print("4. View All Books")
            print("5. Search")
            print("6. Exit")

            choice = input("Enter choice (1-6): ").strip()
            if choice == "1":
                title = prompt_non_empty("Title: ")
                author = prompt_non_empty("Author: ")
                isbn = prompt_non_empty("ISBN: ")
                try:
                    book = Book(title=title, author=author, isbn=isbn)
                    inventory.add_book(book)
                    inventory.save()
                    print("Book added successfully.")
                except ValueError as ve:
                    print(f"Error: {ve}")

            elif choice == "2":
                isbn = prompt_non_empty("ISBN to issue: ")
                success = inventory.issue_book_by_isbn(isbn)
                inventory.save()
                print("Book issued." if success else "Issue failed (not found or already issued).")

            elif choice == "3":
                isbn = prompt_non_empty("ISBN to return: ")
                success = inventory.return_book_by_isbn(isbn)
                inventory.save()
                print("Book returned." if success else "Return failed (not found or already available).")

            elif choice == "4":
                books = inventory.display_all()
                if not books:
                    print("No books in catalog.")
                else:
                    print("\nCatalog:")
                    for line in books:
                        print(line)

            elif choice == "5":
                print("Search by:\n 1) Title  2) ISBN")
                sub = input("Choose 1 or 2: ").strip()
                if sub == "1":
                    q = prompt_non_empty("Title query: ")
                    results = inventory.search_by_title(q)
                    if not results:
                        print("No matches found.")
                    else:
                        for b in results:
                            print(b)
                elif sub == "2":
                    q = prompt_non_empty("ISBN: ")
                    result = inventory.search_by_isbn(q)
                    if result:
                        print(result)
                    else:
                        print("No book with that ISBN.")
                else:
                    print("Invalid selection.")

            elif choice == "6":
                print("Exiting — saving catalog.")
                break
            else:
                print("Invalid choice. Choose 1-6.")

    except KeyboardInterrupt:
        print("\nInterrupted by user — exiting.")
    finally:
        try:
            inventory.save()
        except Exception as e:
            logger.error(f"Failed to save on exit: {e}")


if __name__ == "__main__":
    main()
